generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Region {
  EU
  NA
  SAM
  MENA
  OCE
  APAC
  SSA
  Deleted
}

model AppUser {
  appUserId           String        @id @default(dbgenerated("uuid_generate_v4()")) @map("app_user_id") @db.Uuid
  firstName           String        @map("first_name")
  lastName            String        @map("last_name")
  username            String        @unique
  mail                String        @unique @map("mail_address") @db.Citext
  passwordHash        String        @map("password_hash")
  avatarUrl           String?       @map("avatar_url")
  availability        Boolean       @default(false)
  region              Region
  createdAt           DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime?     @map("deleted_at") @db.Timestamptz(6)
  lastConnectedAt     DateTime      @default(now()) @map("last_connected_at") @db.Timestamptz(6)
  chatBansGiven       ChatBan[]     @relation("ChatBanBannedBy")
  chatBansReceived    ChatBan[]     @relation("ChatBanUser")
  chatMemberships     ChatMember[]  @relation("UserChatMemberships")
  moderatedMessages   ChatMessage[] @relation("MessageModerator")
  messages            ChatMessage[] @relation("MessageAuthor")
  chatRolesGiven      ChatRole[]    @relation("ChatRoleAttributedBy")
  chatRoles           ChatRole[]    @relation("ChatRoleUser")
  friendshipsReceived Friendship[]  @relation("FriendshipReceiver")
  friendshipsSent     Friendship[]  @relation("FriendshipSender")
  gameProfile         GameProfile?
  gameResults         GameResult[]
  privateChatsAsUser1 PrivateChat[] @relation("PrivateChatUser1")
  privateChatsAsUser2 PrivateChat[] @relation("PrivateChatUser2")
  rolesGiven          UserRole[]    @relation("UserRoleAttributedBy")
  rolesReceived       UserRole[]    @relation("UserRoleAttributedTo")

  @@map("app_user")
}

model Chat {
  chatId    String        @id @default(dbgenerated("uuid_generate_v4()")) @map("chat_id") @db.Uuid
  createdAt DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime?     @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime?     @map("deleted_at") @db.Timestamptz(6)
  chatType  String        @default("private") @map("chat_type") @db.VarChar(20)
  chatName  String        @map("chat_name") @db.VarChar(255)
  bans      ChatBan[]
  members   ChatMember[]  @relation("ChatMembers")
  messages  ChatMessage[]
  roles     ChatRole[]

  @@map("chat")
}

model ChatMember {
  chatMemberId String    @id @default(dbgenerated("uuid_generate_v4()")) @map("chat_member_id") @db.Uuid
  chatId       String?   @map("chat_id") @db.Uuid
  userId       String?   @map("user_id") @db.Uuid
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)
  joinedAt     DateTime? @default(now()) @map("joined_at") @db.Timestamptz(6)
  leftAt       DateTime? @map("left_at") @db.Timestamptz(6)
  chat         Chat?     @relation("ChatMembers", fields: [chatId], references: [chatId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_member_chat")
  user         AppUser?  @relation("UserChatMemberships", fields: [userId], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_member_user")

  @@map("chat_member")
}

model Friendship {
  friendshipId String    @id @default(dbgenerated("uuid_generate_v4()")) @map("friendship_id") @db.Uuid
  senderId     String?   @map("sender_id") @db.Uuid
  receiverId   String?   @map("receiver_id") @db.Uuid
  status       String    @default("waiting") @db.VarChar(10)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)
  receiver     AppUser?  @relation("FriendshipReceiver", fields: [receiverId], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_friendship_receiver")
  sender       AppUser?  @relation("FriendshipSender", fields: [senderId], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_friendship_sender")

  @@map("friendship")
}

model GameProfile {
  gameProfileId      String    @id @default(dbgenerated("uuid_generate_v4()")) @map("game_profile_id") @db.Uuid
  userId             String    @unique @map("user_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt          DateTime? @map("deleted_at") @db.Timestamptz(6)
  totalGames         Int       @default(0) @map("total_games")
  totalWins          Int       @default(0) @map("total_wins")
  totalLoses         Int       @default(0) @map("total_loses")
  totalEnemiesKilled Int       @default(0) @map("total_ennemies_killed")
  totalXp            Int       @default(0) @map("total_xp")
  level              Int       @default(0) @map("level")
  bestTime           Int       @default(0) @map("best_time")
  user               AppUser   @relation(fields: [userId], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_game_profile_user_id")

  @@map("game_profile")
}

model GameResult {
  gameResultId   String       @id @default(dbgenerated("uuid_generate_v4()")) @map("game_result_id") @db.Uuid
  gameId         String?      @map("game_id") @db.Uuid
  playerId       String?      @map("player_id") @db.Uuid
  createdAt      DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?    @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime?    @map("deleted_at") @db.Timestamptz(6)
  completionTime Int?         @map("completion_time")
  enemiesKilled  Int          @default(0) @map("ennemies_killed")
  gainedXp       Int          @default(0) @map("gained_xp")
  isWinner       Boolean      @default(false) @map("is_winner")
  gameSession    GameSession? @relation(fields: [gameId], references: [sessionId], onDelete: NoAction, onUpdate: NoAction, map: "fk_game_result_match")
  player         AppUser?     @relation(fields: [playerId], references: [appUserId], onDelete: Cascade, onUpdate: NoAction, map: "fk_game_result_user")

  @@map("game_result")
}

model GameSession {
  sessionId String       @id @default(dbgenerated("uuid_generate_v4()")) @map("session_id") @db.Uuid
  createdAt DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime?    @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime?    @map("deleted_at") @db.Timestamptz(6)
  mapName   String       @map("map_name") @db.VarChar(100)
  startedAt DateTime     @default(now()) @map("started_at") @db.Timestamptz(6)
  endedAt   DateTime?    @map("ended_at") @db.Timestamptz(6)
  status    String       @default("finished") @db.VarChar(20)
  results   GameResult[]

  @@map("game_session")
}

model UserRole {
  userRoleId   String    @id @default(dbgenerated("uuid_generate_v4()")) @map("user_role_id") @db.Uuid
  attributedTo String?   @map("attributed_to") @db.Uuid
  attributedBy String?   @map("attributed_by") @db.Uuid
  role         String    @default("guest") @db.VarChar(20)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)
  giver        AppUser?  @relation("UserRoleAttributedBy", fields: [attributedBy], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_role_giver")
  receiver     AppUser?  @relation("UserRoleAttributedTo", fields: [attributedTo], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_role_receiver")

  @@map("user_role")
}

model ChatBan {
  chatBanId  String    @id @default(dbgenerated("uuid_generate_v4()")) @map("chat_ban_id") @db.Uuid
  chatId     String?   @map("chat_id") @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  bannedById String?   @map("banned_by") @db.Uuid
  bannedAt   DateTime? @default(now()) @map("banned_at") @db.Timestamptz(6)
  reason     String?
  expiresAt  DateTime? @map("expires_at") @db.Timestamptz(6)
  updatedAt  DateTime? @map("updated_at") @db.Timestamptz(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)
  bannedBy   AppUser?  @relation("ChatBanBannedBy", fields: [bannedById], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_ban_banned_by")
  chat       Chat?     @relation(fields: [chatId], references: [chatId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_ban_chat")
  user       AppUser?  @relation("ChatBanUser", fields: [userId], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_ban_user")

  @@map("chat_ban")
}

model ChatMessage {
  messageId     String         @id @default(dbgenerated("uuid_generate_v4()")) @map("message_id") @db.Uuid
  chatId        String         @map("chat_id") @db.Uuid
  userId        String         @map("user_id") @db.Uuid
  content       String
  status        message_status @default(posted) @map("status")
  postedAt      DateTime?      @default(now()) @map("posted_at") @db.Timestamptz(6)
  editedAt      DateTime?      @map("edited_at") @db.Timestamptz(6)
  deletedAt     DateTime?      @map("deleted_at") @db.Timestamptz(6)
  moderatedById String?        @map("moderated_by") @db.Uuid
  chat          Chat           @relation(fields: [chatId], references: [chatId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_message_chat")
  moderator     AppUser?       @relation("MessageModerator", fields: [moderatedById], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_message_moderated_by")
  author        AppUser        @relation("MessageAuthor", fields: [userId], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_message_user")

  @@map("chat_message")
}

model ChatRole {
  chatRoleId     String         @id @default(dbgenerated("uuid_generate_v4()")) @map("chat_role_id") @db.Uuid
  chatId         String?        @map("chat_id") @db.Uuid
  userId         String?        @map("user_id") @db.Uuid
  role           chat_role_type @map("role")
  attributedById String?        @map("attributed_by") @db.Uuid
  attributedAt   DateTime?      @default(now()) @map("attributed_at") @db.Timestamptz(6)
  modifiedAt     DateTime?      @map("modified_at") @db.Timestamptz(6)
  deletedAt      DateTime?      @map("deleted_at") @db.Timestamptz(6)
  attributedBy   AppUser?       @relation("ChatRoleAttributedBy", fields: [attributedById], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_role_attributed_by")
  chat           Chat?          @relation(fields: [chatId], references: [chatId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_role_chat")
  user           AppUser?       @relation("ChatRoleUser", fields: [userId], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_chat_role_user")

  @@map("chat_role")
}

model PrivateChat {
  privateChatId String    @id @default(dbgenerated("uuid_generate_v4()")) @map("private_chat_id") @db.Uuid
  user1Id       String?   @map("user1_id") @db.Uuid
  user2Id       String?   @map("user2_id") @db.Uuid
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)
  user1         AppUser?  @relation("PrivateChatUser1", fields: [user1Id], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_private_chat_user1")
  user2         AppUser?  @relation("PrivateChatUser2", fields: [user2Id], references: [appUserId], onDelete: NoAction, onUpdate: NoAction, map: "fk_private_chat_user2")

  @@map("private_chat")
}

enum chat_role_type {
  owner
  admin
  moderator
  read_only
}

enum message_status {
  posted
  edited
  deleted
  moderated
}
