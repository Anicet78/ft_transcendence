<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test wasm</title>
    <style>
        body
        {
            font-family: sans-serif;
            margin: 20px;
        }

        #game-canvas
        {
            display: block;
            margin: 0 auto;
        }

        #log
        {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin: 20px auto 0 auto;
        }

        #msg {width: 300px;}

    </style>
</head>
<body>
    <div>
        <button id="connectBtn">Se connecter</button>
        <button id="disconnectBtn" disabled>Se d√©connecter</button>
    </div>
    <form id="myForm">
        <label> id : <input type="text" id="id" name="id"> </label>
        <br>
        <label> Nom : <input type="text" id="name" name="name"> </label>
        <br>
        <button type="submit">Envoyer</button>
    </form>
    <canvas id="game-canvas" width="800" height="950" tabindex="1"></canvas>
    <div id="log"></div>
    <script src="game.js"></script>
    <script>
        let socket = null;
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logDiv = document.getElementById('log');

        let Module = null;

        const form = document.getElementById('myForm');
        let name;
        let id;

        form.addEventListener('submit', function (event)
        {
            event.preventDefault();

            name = document.getElementById('name').value;
            id = document.getElementById('id').value;
        });



        function startGame()
        {
            createModule({
                canvas: document.getElementById("game-canvas"),
                noInitialRun: true
            }).then(mod => {
                Module = mod;
                Module.callMain([name, id]);
            });
        }

        
        function log(text)
        {
            if (logDiv.childElementCount > 25) {
                logDiv.removeChild(logDiv.firstChild);
            }

            const p = document.createElement('p');
            p.textContent = text;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }


		function onCppMessage(obj)
		{
			const payload = JSON.stringify(obj);

			log('üì§ Envoy√© JSON : ' + payload);
			socket.send(payload);
		}

        function sendResults(obj)
		{
			const payload = JSON.stringify(obj);

			log('End of game !! \n ' + payload);
            disconnect();
		}

        function disconnect()
        {
            if (socket)
            {
                socket.close();
                socket = null;
            }

            if (Module)
            {
                if (Module.finishGame)
                    Module.finishGame();

                if (Module.ctx)
                {
                    const ext = Module.ctx.getExtension('WEBGL_lose_context');
                    if (ext)
                        ext.loseContext();
                }

                Module = null;
            }

            const oldCanvas = document.getElementById("game-canvas");
            const newCanvas = oldCanvas.cloneNode(true);
            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);
        }


        connectBtn.onclick = () => {
            socket = new WebSocket('ws://localhost:3000');

           socket.onopen = () => {
                log('‚úÖ Connect√© au serveur');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;

                startGame();
            };


            socket.onmessage = async (event) => {
                let data = event.data;

                if (data instanceof Blob)
                    data = await data.text();

                try {
                    const json = JSON.parse(data);
                    log('üì• Re√ßu JSON : ' + JSON.stringify(json, null, 2));

                    if (Module && Module.getMessage) {
                        Module.getMessage(json);
                    } else {
                        log("‚ö†Ô∏è Module pas encore pr√™t, message ignor√©");
                    }
                }
                // catch {
                //     log('üì• Re√ßu (non-JSON) : ' + data);
                // }
                catch (e) {
                    console.error("‚ùå JSON.parse error:", e);
                    console.log("Type:", typeof data);
                    console.log("Raw data:", data);
                    log('üì• Re√ßu (non-JSON) : ' + data);
                }
            };


            socket.onclose = () => {
                log('‚ùå D√©connect√© du serveur');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };

            socket.onerror = (err) => {
                log('‚ö†Ô∏è Erreur WebSocket');
                console.error(err);
            };
        };


        disconnectBtn.onclick = () =>
        {
            disconnect();
        };





    </script>
</body>
</html>
