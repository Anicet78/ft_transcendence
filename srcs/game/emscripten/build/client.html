<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test wasm</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
        #msg { width: 300px; }
    </style>
</head>
<body>
    <div>
        <button id="connectBtn">Se connecter</button>
        <button id="disconnectBtn" disabled>Se d√©connecter</button>
    </div>
    <canvas id="game-canvas" width="800" height="800" tabindex="1"></canvas>
    <div id="log"></div>
    <script>
        let socket = null;
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logDiv = document.getElementById('log');


        var Module =
        {
			canvas: document.getElementById("game-canvas"),
            noInitialRun: true,
            // emp√™che main() de se lancer automatiquement
            onRuntimeInitialized()
            {
                console.log("WASM pr√™t, en attente du bouton‚Ä¶");
            }
		};

        function log(text)
        {
            if (logDiv.childElementCount > 50) {
                logDiv.removeChild(logDiv.firstChild);
            }

            const p = document.createElement('p');
            p.textContent = text;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }


		function onCppMessage(obj)
		{
			const payload = JSON.stringify(obj);

			log('üì§ Envoy√© JSON : ' + payload);
			socket.send(payload);
		}

        connectBtn.onclick = () => {
            socket = new WebSocket('ws://localhost:3000');

            socket.onopen = () => {
                log('‚úÖ Connect√© au serveur');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                Module.callMain([]);
            };

            socket.onmessage = async (event) => {
                let data = event.data;

                // Si le serveur envoie un Blob ‚Üí on convertit en texte
                if (data instanceof Blob)
                {
                    data = await data.text();
                }
                try
                {
                    const json = JSON.parse(data);
                    log('üì• Re√ßu JSON : ' + JSON.stringify(json, null, 2));
                    Module.getMessage(json);
                }
                catch
                {
                    log('üì• Re√ßu (non-JSON) : ' + data);
                }
            };

            socket.onclose = () => {
                log('‚ùå D√©connect√© du serveur');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };

            socket.onerror = (err) => {
                log('‚ö†Ô∏è Erreur WebSocket');
                console.error(err);
            };
        };


        disconnectBtn.onclick = () =>
        {
            if (socket)
            {
                socket.close();
                socket = null;
            }
        };
    </script>
    <script src="game.js"></script>
</body>
</html>
